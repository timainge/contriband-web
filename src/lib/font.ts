// Pixel fonts for text-to-template rendering
// '#' = filled pixel, '.' = empty pixel

import type { Template } from './template';

// 3x5 compact font - minimum legible size
// Each character is 3 columns wide, 5 rows tall
export const FONT_3X5: Record<string, string[]> = {
  A: ['.#.', '#.#', '###', '#.#', '#.#'],
  B: ['##.', '#.#', '##.', '#.#', '##.'],
  C: ['.##', '#..', '#..', '#..', '.##'],
  D: ['##.', '#.#', '#.#', '#.#', '##.'],
  E: ['###', '#..', '##.', '#..', '###'],
  F: ['###', '#..', '##.', '#..', '#..'],
  G: ['.##', '#..', '#.#', '#.#', '.##'],
  H: ['#.#', '#.#', '###', '#.#', '#.#'],
  I: ['###', '.#.', '.#.', '.#.', '###'],
  J: ['###', '..#', '..#', '#.#', '.#.'],
  K: ['#.#', '#.#', '##.', '#.#', '#.#'],
  L: ['#..', '#..', '#..', '#..', '###'],
  M: ['#.#', '###', '###', '#.#', '#.#'],
  N: ['#.#', '###', '###', '###', '#.#'],
  O: ['.#.', '#.#', '#.#', '#.#', '.#.'],
  P: ['##.', '#.#', '##.', '#..', '#..'],
  Q: ['.#.', '#.#', '#.#', '.#.', '..#'],
  R: ['##.', '#.#', '##.', '#.#', '#.#'],
  S: ['.##', '#..', '.#.', '..#', '##.'],
  T: ['###', '.#.', '.#.', '.#.', '.#.'],
  U: ['#.#', '#.#', '#.#', '#.#', '.#.'],
  V: ['#.#', '#.#', '#.#', '.#.', '.#.'],
  W: ['#.#', '#.#', '###', '###', '#.#'],
  X: ['#.#', '#.#', '.#.', '#.#', '#.#'],
  Y: ['#.#', '#.#', '.#.', '.#.', '.#.'],
  Z: ['###', '..#', '.#.', '#..', '###'],
  '0': ['.#.', '#.#', '#.#', '#.#', '.#.'],
  '1': ['.#.', '##.', '.#.', '.#.', '###'],
  '2': ['.#.', '#.#', '..#', '.#.', '###'],
  '3': ['###', '..#', '.#.', '..#', '###'],
  '4': ['#.#', '#.#', '###', '..#', '..#'],
  '5': ['###', '#..', '##.', '..#', '##.'],
  '6': ['.##', '#..', '###', '#.#', '.#.'],
  '7': ['###', '..#', '.#.', '.#.', '.#.'],
  '8': ['.#.', '#.#', '.#.', '#.#', '.#.'],
  '9': ['.#.', '#.#', '.##', '..#', '.#.'],
  ' ': ['...', '...', '...', '...', '...'],
  '!': ['.#.', '.#.', '.#.', '...', '.#.'],
  '?': ['.#.', '#.#', '..#', '.#.', '.#.'],
  '.': ['...', '...', '...', '...', '.#.'],
  ',': ['...', '...', '...', '.#.', '#..'],
  '-': ['...', '...', '###', '...', '...'],
  '+': ['...', '.#.', '###', '.#.', '...'],
  ':': ['...', '.#.', '...', '.#.', '...'],
  "'": ['.#.', '.#.', '...', '...', '...'],
};

// 5x7 standard font - more readable
export const FONT_5X7: Record<string, string[]> = {
  A: ['.###.', '#...#', '#...#', '#####', '#...#', '#...#', '#...#'],
  B: ['####.', '#...#', '#...#', '####.', '#...#', '#...#', '####.'],
  C: ['.###.', '#...#', '#....', '#....', '#....', '#...#', '.###.'],
  D: ['####.', '#...#', '#...#', '#...#', '#...#', '#...#', '####.'],
  E: ['#####', '#....', '#....', '####.', '#....', '#....', '#####'],
  F: ['#####', '#....', '#....', '####.', '#....', '#....', '#....'],
  G: ['.###.', '#...#', '#....', '#.###', '#...#', '#...#', '.###.'],
  H: ['#...#', '#...#', '#...#', '#####', '#...#', '#...#', '#...#'],
  I: ['#####', '..#..', '..#..', '..#..', '..#..', '..#..', '#####'],
  J: ['..###', '...#.', '...#.', '...#.', '#..#.', '#..#.', '.##..'],
  K: ['#...#', '#..#.', '#.#..', '##...', '#.#..', '#..#.', '#...#'],
  L: ['#....', '#....', '#....', '#....', '#....', '#....', '#####'],
  M: ['#...#', '##.##', '#.#.#', '#.#.#', '#...#', '#...#', '#...#'],
  N: ['#...#', '##..#', '#.#.#', '#..##', '#...#', '#...#', '#...#'],
  O: ['.###.', '#...#', '#...#', '#...#', '#...#', '#...#', '.###.'],
  P: ['####.', '#...#', '#...#', '####.', '#....', '#....', '#....'],
  Q: ['.###.', '#...#', '#...#', '#...#', '#.#.#', '#..#.', '.##.#'],
  R: ['####.', '#...#', '#...#', '####.', '#.#..', '#..#.', '#...#'],
  S: ['.####', '#....', '#....', '.###.', '....#', '....#', '####.'],
  T: ['#####', '..#..', '..#..', '..#..', '..#..', '..#..', '..#..'],
  U: ['#...#', '#...#', '#...#', '#...#', '#...#', '#...#', '.###.'],
  V: ['#...#', '#...#', '#...#', '#...#', '#...#', '.#.#.', '..#..'],
  W: ['#...#', '#...#', '#...#', '#.#.#', '#.#.#', '##.##', '#...#'],
  X: ['#...#', '#...#', '.#.#.', '..#..', '.#.#.', '#...#', '#...#'],
  Y: ['#...#', '#...#', '.#.#.', '..#..', '..#..', '..#..', '..#..'],
  Z: ['#####', '....#', '...#.', '..#..', '.#...', '#....', '#####'],
  '0': ['.###.', '#...#', '#..##', '#.#.#', '##..#', '#...#', '.###.'],
  '1': ['..#..', '.##..', '..#..', '..#..', '..#..', '..#..', '.###.'],
  '2': ['.###.', '#...#', '....#', '..##.', '.#...', '#....', '#####'],
  '3': ['.###.', '#...#', '....#', '..##.', '....#', '#...#', '.###.'],
  '4': ['...#.', '..##.', '.#.#.', '#..#.', '#####', '...#.', '...#.'],
  '5': ['#####', '#....', '####.', '....#', '....#', '#...#', '.###.'],
  '6': ['.###.', '#....', '#....', '####.', '#...#', '#...#', '.###.'],
  '7': ['#####', '....#', '...#.', '..#..', '.#...', '.#...', '.#...'],
  '8': ['.###.', '#...#', '#...#', '.###.', '#...#', '#...#', '.###.'],
  '9': ['.###.', '#...#', '#...#', '.####', '....#', '....#', '.###.'],
  ' ': ['.....', '.....', '.....', '.....', '.....', '.....', '.....'],
  '!': ['..#..', '..#..', '..#..', '..#..', '..#..', '.....', '..#..'],
  '?': ['.###.', '#...#', '....#', '..##.', '..#..', '.....', '..#..'],
  '.': ['.....', '.....', '.....', '.....', '.....', '.....', '..#..'],
  ',': ['.....', '.....', '.....', '.....', '.....', '..#..', '.#...'],
  '-': ['.....', '.....', '.....', '#####', '.....', '.....', '.....'],
  '+': ['.....', '..#..', '..#..', '#####', '..#..', '..#..', '.....'],
  ':': ['.....', '..#..', '.....', '.....', '.....', '..#..', '.....'],
  "'": ['..#..', '..#..', '.....', '.....', '.....', '.....', '.....'],
  '/': ['....#', '...#.', '...#.', '..#..', '.#...', '.#...', '#....'],
  '#': ['.#.#.', '.#.#.', '#####', '.#.#.', '#####', '.#.#.', '.#.#.'],
  '*': ['.....', '#.#.#', '.###.', '#####', '.###.', '#.#.#', '.....'],
  '<': ['...#.', '..#..', '.#...', '#....', '.#...', '..#..', '...#.'],
  '>': ['.#...', '..#..', '...#.', '....#', '...#.', '..#..', '.#...'],
};

// Fallback characters
const FALLBACK_3X5: string[] = ['###', '#.#', '#.#', '#.#', '###'];
const FALLBACK_5X7: string[] = ['#####', '#...#', '#...#', '#...#', '#...#', '#...#', '#####'];

export type FontSize = '3x5' | '5x7';

export function getCharPattern(char: string, fontSize: FontSize = '5x7'): string[] {
  const font = fontSize === '3x5' ? FONT_3X5 : FONT_5X7;
  const fallback = fontSize === '3x5' ? FALLBACK_3X5 : FALLBACK_5X7;
  return font[char.toUpperCase()] || fallback;
}

export function renderText(
  text: string,
  spacing: number = 1,
  fontSize: FontSize = '5x7',
  verticalAlign: 'top' | 'center' | 'bottom' = 'top'
): Template {
  if (!text) {
    throw new Error('Text cannot be empty');
  }

  const fontHeight = fontSize === '3x5' ? 5 : 7;
  const charWidth = fontSize === '3x5' ? 3 : 5;

  // Calculate vertical padding for centering in 7-row grid
  let topPadding = 0;
  if (fontHeight < 7) {
    const extraRows = 7 - fontHeight;
    if (verticalAlign === 'center') {
      topPadding = Math.floor(extraRows / 2);
    } else if (verticalAlign === 'bottom') {
      topPadding = extraRows;
    }
  }

  // Build character patterns first
  const charGrids: number[][][] = [];
  for (const char of text) {
    const pattern = getCharPattern(char, fontSize);
    const charGrid: number[][] = [];
    for (const row of pattern) {
      charGrid.push([...row].map(p => (p === '#' ? 4 : 0)));
    }
    charGrids.push(charGrid);
  }

  // Calculate total width
  let totalWidth = 0;
  for (let i = 0; i < charGrids.length; i++) {
    if (i > 0) totalWidth += spacing;
    totalWidth += charWidth;
  }

  // Build final 7-row grid
  const grid: number[][] = [];
  for (let row = 0; row < 7; row++) {
    const rowData: number[] = [];

    for (let i = 0; i < charGrids.length; i++) {
      // Add spacing between characters
      if (i > 0) {
        for (let s = 0; s < spacing; s++) {
          rowData.push(0);
        }
      }

      // Add character data (with vertical offset)
      const charRow = row - topPadding;
      const charGrid = charGrids[i]!;
      if (charRow >= 0 && charRow < fontHeight && charGrid[charRow]) {
        rowData.push(...charGrid[charRow]!);
      } else {
        // Padding row - fill with zeros
        for (let c = 0; c < charWidth; c++) {
          rowData.push(0);
        }
      }
    }

    grid.push(rowData);
  }

  return {
    name: `text-${text.slice(0, 20)}`,
    grid,
    width: totalWidth,
    height: 7,
  };
}
